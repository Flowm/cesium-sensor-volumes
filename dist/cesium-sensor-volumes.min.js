!function(e,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(e="undefined"!=typeof globalThis?globalThis:e||self).CesiumSensorVolumes=i()}(this,function(){"use strict";
/**
	 * Cesium Sensor Volumes - https://github.com/Flowm/cesium-sensor-volumes
	 *
	 * Copyright 2016 Jonathan Lounsbury
	 * Copyright 2011-2014 Analytical Graphics Inc. and Cesium Contributors
	 *
	 * Licensed under the Apache License, Version 2.0 (the "License");
	 * you may not use this file except in compliance with the License.
	 * You may obtain a copy of the License at
	 *
	 * http://www.apache.org/licenses/LICENSE-2.0
	 *
	 * Unless required by applicable law or agreed to in writing, software
	 * distributed under the License is distributed on an "AS IS" BASIS,
	 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	 * See the License for the specific language governing permissions and
	 * limitations under the License.
	 *
	 * Portions licensed separately.
	 * See https://github.com/Flowm/cesium-sensor-volumes/blob/master/LICENSE.md for full licensing details.
	 *
	 * Derived from Cesium Sensors - https://github.com/AnalyticalGraphicsInc/cesium-sensors
	 */const e=Cesium.createPropertyDescriptor,i=Cesium.createMaterialPropertyDescriptor,t=Cesium.defined,o=Cesium.DeveloperError,n=Cesium.Event,r=Cesium.Frozen,s=Cesium.Cartesian3,a=Cesium.SceneMode,l=Cesium.RenderState,h=Cesium.BlendingState,c=Cesium.CullFace,u=Cesium.Pass,d=Cesium.Matrix4,m=Cesium.BoundingSphere,f=Cesium.ShaderSource,_=Cesium.ShaderProgram,p=Cesium.combine,C=Cesium.destroyObject,g=Cesium.DrawCommand,v=Cesium.PrimitiveType,w=Cesium.Material,S=Cesium.Color,y=Cesium.Buffer,A=Cesium.BufferUsage,M=Cesium.ComponentDatatype,x=Cesium.VertexArray,I=Cesium.Matrix3,T=Cesium.Quaternion,b=Cesium.AssociativeArray,E=Cesium.Property,k=Cesium.Math,P=Cesium.MaterialProperty,H=Cesium.Spherical,V=Cesium.clone,W=Cesium.CzmlDataSource,O=Cesium.DataSourceDisplay,F=Cesium.TimeInterval,D=function(e){this._minimumClockAngle=void 0,this._minimumClockAngleSubscription=void 0,this._maximumClockAngle=void 0,this._maximumClockAngleSubscription=void 0,this._innerHalfAngle=void 0,this._innerHalfAngleSubscription=void 0,this._outerHalfAngle=void 0,this._outerHalfAngleSubscription=void 0,this._lateralSurfaceMaterial=void 0,this._lateralSurfaceMaterialSubscription=void 0,this._intersectionColor=void 0,this._intersectionColorSubscription=void 0,this._intersectionWidth=void 0,this._intersectionWidthSubscription=void 0,this._showIntersection=void 0,this._showIntersectionSubscription=void 0,this._radius=void 0,this._radiusSubscription=void 0,this._show=void 0,this._showSubscription=void 0,this._definitionChanged=new n,this.merge(e??r.EMPTY_OBJECT)};Object.defineProperties(D.prototype,{definitionChanged:{get:function(){return this._definitionChanged}},minimumClockAngle:e("minimumClockAngle"),maximumClockAngle:e("maximumClockAngle"),innerHalfAngle:e("innerHalfAngle"),outerHalfAngle:e("outerHalfAngle"),lateralSurfaceMaterial:i("lateralSurfaceMaterial"),intersectionColor:e("intersectionColor"),intersectionWidth:e("intersectionWidth"),showIntersection:e("showIntersection"),radius:e("radius"),show:e("show")}),D.prototype.clone=function(e){return t(e)||(e=new D),e.show=this.show,e.innerHalfAngle=this.innerHalfAngle,e.outerHalfAngle=this.outerHalfAngle,e.minimumClockAngle=this.minimumClockAngle,e.maximumClockAngle=this.maximumClockAngle,e.radius=this.radius,e.showIntersection=this.showIntersection,e.intersectionColor=this.intersectionColor,e.intersectionWidth=this.intersectionWidth,e.lateralSurfaceMaterial=this.lateralSurfaceMaterial,e},D.prototype.merge=function(e){if(!t(e))throw new o("source is required.");this.show=this.show??e.show,this.innerHalfAngle=this.innerHalfAngle??e.innerHalfAngle,this.outerHalfAngle=this.outerHalfAngle??e.outerHalfAngle,this.minimumClockAngle=this.minimumClockAngle??e.minimumClockAngle,this.maximumClockAngle=this.maximumClockAngle??e.maximumClockAngle,this.radius=this.radius??e.radius,this.showIntersection=this.showIntersection??e.showIntersection,this.intersectionColor=this.intersectionColor??e.intersectionColor,this.intersectionWidth=this.intersectionWidth??e.intersectionWidth,this.lateralSurfaceMaterial=this.lateralSurfaceMaterial??e.lateralSurfaceMaterial};var z="#version 300 es\n\nuniform vec4 u_intersectionColor;\nuniform float u_intersectionWidth;\n\nbool inSensorShadow(vec3 coneVertexWC, vec3 pointWC)\n{\n    \n    vec3 D = czm_ellipsoidInverseRadii;\n\n    \n    vec3 q = D * coneVertexWC;\n    float qMagnitudeSquared = dot(q, q);\n    float test = qMagnitudeSquared - 1.0;\n\n    \n    vec3 temp = D * pointWC - q;\n    float d = dot(temp, q);\n\n    \n    return (d < -test) && (d / length(temp) < -sqrt(test));\n}\n\nvec4 getIntersectionColor()\n{\n    return u_intersectionColor;\n}\n\nfloat getIntersectionWidth()\n{\n    return u_intersectionWidth;\n}\n\nvec2 sensor2dTextureCoordinates(float sensorRadius, vec3 pointMC)\n{\n    \n    float t = pointMC.z / sensorRadius;\n    float s = 1.0 + (atan(pointMC.y, pointMC.x) / czm_twoPi);\n    s = s - floor(s);\n\n    return vec2(s, t);\n}\n",R="#version 300 es\n\nuniform bool u_showIntersection;\nuniform bool u_showThroughEllipsoid;\n\nuniform float u_sensorRadius;\nuniform float u_normalDirection;\n\nin vec3 v_positionWC;\nin vec3 v_positionEC;\nin vec3 v_normalEC;\n\nvec4 getColor(float sensorRadius, vec3 pointEC)\n{\n    czm_materialInput materialInput;\n\n    vec3 pointMC = (czm_inverseModelView * vec4(pointEC, 1.0)).xyz;\n    materialInput.st = sensor2dTextureCoordinates(sensorRadius, pointMC);\n    materialInput.str = pointMC / sensorRadius;\n\n    vec3 positionToEyeEC = -v_positionEC;\n    materialInput.positionToEyeEC = positionToEyeEC;\n\n    vec3 normalEC = normalize(v_normalEC);\n    materialInput.normalEC = u_normalDirection * normalEC;\n\n    czm_material material = czm_getMaterial(materialInput);\n    return mix(czm_phong(normalize(positionToEyeEC), material, czm_lightDirectionEC), vec4(material.diffuse, material.alpha), 0.4);\n}\n\nbool isOnBoundary(float value, float epsilon)\n{\n    float width = getIntersectionWidth();\n    float tolerance = width * epsilon;\n\n    float delta = max(abs(dFdx(value)), abs(dFdy(value)));\n    float pixels = width * delta;\n    float temp = abs(value);\n    \n    \n    \n    \n    \n    \n    \n    return temp < tolerance && temp < pixels || (delta < 10.0 * tolerance && temp - delta < tolerance && temp < pixels);\n}\n\nvec4 shade(bool isOnBoundary)\n{\n    if (u_showIntersection && isOnBoundary)\n    {\n        return getIntersectionColor();\n    }\n    return getColor(u_sensorRadius, v_positionEC);\n}\n\nfloat ellipsoidSurfaceFunction(vec3 point)\n{\n    vec3 scaled = czm_ellipsoidInverseRadii * point;\n    return dot(scaled, scaled) - 1.0;\n}\n\nvoid main()\n{\n    vec3 sensorVertexWC = czm_model[3].xyz;      \n    vec3 sensorVertexEC = czm_modelView[3].xyz;  \n\n    float ellipsoidValue = ellipsoidSurfaceFunction(v_positionWC);\n\n    \n    if (!u_showThroughEllipsoid)\n    {\n        \n        \n        if (ellipsoidValue < 0.0)\n        {\n            discard;\n        }\n\n        \n        if (inSensorShadow(sensorVertexWC, v_positionWC))\n        {\n            discard;\n        }\n    }\n\n    \n    \n    if (distance(v_positionEC, sensorVertexEC) > u_sensorRadius)\n    {\n        discard;\n    }\n\n    \n    bool isOnEllipsoid = isOnBoundary(ellipsoidValue, czm_epsilon3);\n    out_FragColor = shade(isOnEllipsoid);\n}\n",N="#version 300 es\n\nin vec4 position;\nin vec3 normal;\n\nout vec3 v_positionWC;\nout vec3 v_positionEC;\nout vec3 v_normalEC;\n\nvoid main()\n{\n    gl_Position = czm_modelViewProjection * position;\n    v_positionWC = (czm_model * position).xyz;\n    v_positionEC = (czm_modelView * position).xyz;\n    v_normalEC = czm_normal * normal;\n}\n";const q={position:0,normal:1},B=5906376272e3,L=function(e){e=e??r.EMPTY_OBJECT,this._pickId=void 0,this._pickPrimitive=e._pickPrimitive??this,this._frontFaceColorCommand=new g,this._backFaceColorCommand=new g,this._pickCommand=new g,this._boundingSphere=new m,this._boundingSphereWC=new m,this._frontFaceColorCommand.primitiveType=v.TRIANGLES,this._frontFaceColorCommand.boundingVolume=this._boundingSphereWC,this._frontFaceColorCommand.owner=this,this._backFaceColorCommand.primitiveType=this._frontFaceColorCommand.primitiveType,this._backFaceColorCommand.boundingVolume=this._frontFaceColorCommand.boundingVolume,this._backFaceColorCommand.owner=this,this._pickCommand.primitiveType=this._frontFaceColorCommand.primitiveType,this._pickCommand.boundingVolume=this._frontFaceColorCommand.boundingVolume,this._pickCommand.owner=this,this.show=e.show??!0,this.showIntersection=e.showIntersection??!0,this.showThroughEllipsoid=e.showThroughEllipsoid??!1,this._showThroughEllipsoid=this.showThroughEllipsoid,this.modelMatrix=d.clone(e.modelMatrix??d.IDENTITY),this._modelMatrix=new d,this.radius=e.radius??Number.POSITIVE_INFINITY,this._directions=void 0,this._directionsDirty=!1,this.directions=t(e.directions)?e.directions:[],this.lateralSurfaceMaterial=t(e.lateralSurfaceMaterial)?e.lateralSurfaceMaterial:w.fromType(w.ColorType),this._lateralSurfaceMaterial=void 0,this._translucent=void 0,this.intersectionColor=S.clone(e.intersectionColor??S.WHITE),this.intersectionWidth=e.intersectionWidth??5,this.id=e.id,this._id=void 0;var i=this;this._uniforms={u_showThroughEllipsoid:function(){return i.showThroughEllipsoid},u_showIntersection:function(){return i.showIntersection},u_sensorRadius:function(){return isFinite(i.radius)?i.radius:B},u_intersectionColor:function(){return i.intersectionColor},u_intersectionWidth:function(){return i.intersectionWidth},u_normalDirection:function(){return 1}},this._mode=a.SCENE3D};Object.defineProperties(L.prototype,{directions:{get:function(){return this._directions},set:function(e){this._directions=e,this._directionsDirty=!0}}});const U=new s,Y=new s,j=new s;const Q=new s;function G(e,i){for(var t=function(e){for(var i=e._directions,t=i.length,o=new Float32Array(3*t),n=isFinite(e.radius)?e.radius:B,r=[s.ZERO],a=t-2,l=t-1,h=0;h<t;a=l++,l=h++){var c=s.fromSpherical(i[a],U),u=s.fromSpherical(i[l],Y),d=s.fromSpherical(i[h],j),f=Math.max(s.angleBetween(c,u),s.angleBetween(u,d)),_=n/Math.cos(.5*f),p=s.multiplyByScalar(u,_,new s);o[3*l]=p.x,o[3*l+1]=p.y,o[3*l+2]=p.z,r.push(p)}return m.fromPoints(r,e._boundingSphere),o}(e),o=e._directions.length,n=new Float32Array(18*o),r=0,a=o-1,l=0;l<o;a=l++){var h=new s(t[3*a],t[3*a+1],t[3*a+2]),c=new s(t[3*l],t[3*l+1],t[3*l+2]),u=s.normalize(s.cross(c,h,Q),Q);n[r++]=0,n[r++]=0,n[r++]=0,n[r++]=u.x,n[r++]=u.y,n[r++]=u.z,n[r++]=c.x,n[r++]=c.y,n[r++]=c.z,n[r++]=u.x,n[r++]=u.y,n[r++]=u.z,n[r++]=h.x,n[r++]=h.y,n[r++]=h.z,n[r++]=u.x,n[r++]=u.y,n[r++]=u.z}var d=y.createVertexBuffer({context:i,typedArray:new Float32Array(n),usage:A.STATIC_DRAW}),f=6*Float32Array.BYTES_PER_ELEMENT,_=[{index:q.position,vertexBuffer:d,componentsPerAttribute:3,componentDatatype:M.FLOAT,offsetInBytes:0,strideInBytes:f},{index:q.normal,vertexBuffer:d,componentsPerAttribute:3,componentDatatype:M.FLOAT,offsetInBytes:3*Float32Array.BYTES_PER_ELEMENT,strideInBytes:f}];return new x({context:i,attributes:_})}function J(e,i,o){var n=i[e.id];if(t(n)){var r=n.primitive;o.remove(r),r.isDestroyed()||r.destroy(),delete i[e.id]}}L.prototype.update=function(e){if(this._mode=e.mode,this.show&&this._mode===a.SCENE3D){var i=e.context,n=e.commandList;if(this.radius<0)throw new o("this.radius must be greater than or equal to zero.");if(!t(this.lateralSurfaceMaterial))throw new o("this.lateralSurfaceMaterial must be defined.");var r,s=this.lateralSurfaceMaterial.isTranslucent();if(this._showThroughEllipsoid!==this.showThroughEllipsoid||!t(this._frontFaceColorCommand.renderState)||this._translucent!==s)this._showThroughEllipsoid=this.showThroughEllipsoid,this._translucent=s,s?(r=l.fromCache({depthTest:{enabled:!this.showThroughEllipsoid},depthMask:!1,blending:h.ALPHA_BLEND,cull:{enabled:!0,face:c.BACK}}),this._frontFaceColorCommand.renderState=r,this._frontFaceColorCommand.pass=u.TRANSLUCENT,r=l.fromCache({depthTest:{enabled:!this.showThroughEllipsoid},depthMask:!1,blending:h.ALPHA_BLEND,cull:{enabled:!0,face:c.FRONT}}),this._backFaceColorCommand.renderState=r,this._backFaceColorCommand.pass=u.TRANSLUCENT,r=l.fromCache({depthTest:{enabled:!this.showThroughEllipsoid},depthMask:!1,blending:h.ALPHA_BLEND}),this._pickCommand.renderState=r):(r=l.fromCache({depthTest:{enabled:!0},depthMask:!0}),this._frontFaceColorCommand.renderState=r,this._frontFaceColorCommand.pass=u.OPAQUE,r=l.fromCache({depthTest:{enabled:!0},depthMask:!0}),this._pickCommand.renderState=r);var C=this._directionsDirty;if(C){this._directionsDirty=!1,this._va=this._va&&this._va.destroy();var g=this._directions;g&&g.length>=3&&(this._frontFaceColorCommand.vertexArray=G(this,i),this._backFaceColorCommand.vertexArray=this._frontFaceColorCommand.vertexArray,this._pickCommand.vertexArray=this._frontFaceColorCommand.vertexArray)}if(t(this._frontFaceColorCommand.vertexArray)){var v=e.passes,w=!d.equals(this.modelMatrix,this._modelMatrix);w&&d.clone(this.modelMatrix,this._modelMatrix),(C||w)&&m.transform(this._boundingSphere,this.modelMatrix,this._boundingSphereWC),this._frontFaceColorCommand.modelMatrix=this.modelMatrix,this._backFaceColorCommand.modelMatrix=this._frontFaceColorCommand.modelMatrix,this._pickCommand.modelMatrix=this._frontFaceColorCommand.modelMatrix;var S=this._lateralSurfaceMaterial!==this.lateralSurfaceMaterial;if(this._lateralSurfaceMaterial=this.lateralSurfaceMaterial,this._lateralSurfaceMaterial.update(i),v.render){var y=this._frontFaceColorCommand,A=this._backFaceColorCommand;if(S||!t(y.shaderProgram)){var M=new f({sources:[z,this._lateralSurfaceMaterial.shaderSource,R]});y.shaderProgram=_.replaceCache({context:i,shaderProgram:y.shaderProgram,vertexShaderSource:N,fragmentShaderSource:M,attributeLocations:q}),y.uniformMap=p(this._uniforms,this._lateralSurfaceMaterial._uniforms),A.shaderProgram=y.shaderProgram,A.uniformMap=p(this._uniforms,this._lateralSurfaceMaterial._uniforms),A.uniformMap.u_normalDirection=function(){return-1}}s?n.push(this._backFaceColorCommand,this._frontFaceColorCommand):n.push(this._frontFaceColorCommand)}if(v.pick){var x=this._pickCommand;if(t(this._pickId)&&this._id===this.id||(this._id=this.id,this._pickId=this._pickId&&this._pickId.destroy(),this._pickId=i.createPickId({primitive:this._pickPrimitive,id:this.id})),S||!t(x.shaderProgram)){var I=new f({sources:[z,this._lateralSurfaceMaterial.shaderSource,R],pickColorQualifier:"uniform"});x.shaderProgram=_.replaceCache({context:i,shaderProgram:x.shaderProgram,vertexShaderSource:N,fragmentShaderSource:I,attributeLocations:q});var T=this,b={czm_pickColor:function(){return T._pickId.color}};x.uniformMap=p(p(this._uniforms,this._lateralSurfaceMaterial._uniforms),b)}x.pass=s?u.TRANSLUCENT:u.OPAQUE,n.push(x)}}}},L.prototype.isDestroyed=function(){return!1},L.prototype.destroy=function(){return this._frontFaceColorCommand.vertexArray=this._frontFaceColorCommand.vertexArray&&this._frontFaceColorCommand.vertexArray.destroy(),this._frontFaceColorCommand.shaderProgram=this._frontFaceColorCommand.shaderProgram&&this._frontFaceColorCommand.shaderProgram.destroy(),this._pickCommand.shaderProgram=this._pickCommand.shaderProgram&&this._pickCommand.shaderProgram.destroy(),this._pickId=this._pickId&&this._pickId.destroy(),C(this)};const K=S.WHITE,Z=Number.POSITIVE_INFINITY,X=new I,$=new s,ee=new T;function ie(e,i,o,n){var r=i[e];t(r)||(r=new H,i[e]=r),r.clock=o,r.cone=n,r.magnitude=1}function te(e,i,t,o,n){var r,s=e.directions,a=0,l=k.toRadians(2);if(0===i&&t===k.TWO_PI)for(r=0;r<k.TWO_PI;r+=l)ie(a++,s,r,n);else{for(r=i;r<t;r+=l)ie(a++,s,r,n);if(ie(a++,s,t,n),o){for(r=t;r>i;r-=l)ie(a++,s,r,o);ie(a++,s,i,o)}else ie(a++,s,t,0)}s.length=a,e.directions=s}const oe=function(e,i){if(!t(e))throw new o("scene is required.");if(!t(i))throw new o("entityCollection is required.");i.collectionChanged.addEventListener(oe.prototype._onCollectionChanged,this),this._scene=e,this._primitives=e.primitives,this._entityCollection=i,this._hash={},this._entitiesToVisualize=new b,this._onCollectionChanged(i,i.values,[],[])};oe.prototype.update=function(e){if(!t(e))throw new o("time is required.");for(var i=this._entitiesToVisualize.values,n=this._hash,r=this._primitives,a=0,l=i.length;a<l;a++){var h,c,u=i[a],m=u._conicSensor,f=n[u.id],_=u.isShowing&&u.isAvailable(e)&&E.getValueOrDefault(m._show,e,!0);if(_&&(h=E.getValueOrUndefined(u._position,e,$),c=E.getValueOrUndefined(u._orientation,e,ee),_=t(h)&&t(c)),_){var p=t(f)?f.primitive:void 0;t(p)||((p=new L).id=u,r.add(p),f={primitive:p,position:void 0,orientation:void 0,minimumClockAngle:void 0,maximumClockAngle:void 0,innerHalfAngle:void 0,outerHalfAngle:void 0},n[u.id]=f),s.equals(h,f.position)&&T.equals(c,f.orientation)||(d.fromRotationTranslation(I.fromQuaternion(c,X),h,p.modelMatrix),f.position=s.clone(h,f.position),f.orientation=T.clone(c,f.orientation)),p.show=!0;var C=E.getValueOrDefault(m._minimumClockAngle,e,0),g=E.getValueOrDefault(m._maximumClockAngle,e,k.TWO_PI),v=E.getValueOrDefault(m._innerHalfAngle,e,0),w=E.getValueOrDefault(m._outerHalfAngle,e,Math.PI);C===f.minimumClockAngle&&g===f.maximumClockAngle&&v===f.innerHalfAngle&&w===f.outerHalfAngle||(te(p,C,g,v,w),f.innerHalfAngle=v,f.maximumClockAngle=g,f.outerHalfAngle=w,f.minimumClockAngle=C),p.radius=E.getValueOrDefault(m._radius,e,Z),p.lateralSurfaceMaterial=P.getValue(e,m._lateralSurfaceMaterial,p.lateralSurfaceMaterial),p.intersectionColor=E.getValueOrClonedDefault(m._intersectionColor,e,K,p.intersectionColor),p.intersectionWidth=E.getValueOrDefault(m._intersectionWidth,e,1)}else t(f)&&(f.primitive.show=!1)}return!0},oe.prototype.isDestroyed=function(){return!1},oe.prototype.destroy=function(){for(var e=this._entitiesToVisualize.values,i=this._hash,t=this._primitives,o=e.length-1;o>-1;o--)J(e[o],i,t);return C(this)},oe.prototype._onCollectionChanged=function(e,i,o,n){var r,s,a=this._entitiesToVisualize,l=this._hash,h=this._primitives;for(r=i.length-1;r>-1;r--)s=i[r],t(s._conicSensor)&&t(s._position)&&t(s._orientation)&&a.set(s.id,s);for(r=n.length-1;r>-1;r--)s=n[r],t(s._conicSensor)&&t(s._position)&&t(s._orientation)?a.set(s.id,s):(J(s,l,h),a.remove(s.id));for(r=o.length-1;r>-1;r--)J(s=o[r],l,h),a.remove(s.id)};const ne=function(e){this._directions=void 0,this._directionsSubscription=void 0,this._lateralSurfaceMaterial=void 0,this._lateralSurfaceMaterialSubscription=void 0,this._intersectionColor=void 0,this._intersectionColorSubscription=void 0,this._intersectionWidth=void 0,this._intersectionWidthSubscription=void 0,this._showIntersection=void 0,this._showIntersectionSubscription=void 0,this._radius=void 0,this._radiusSubscription=void 0,this._show=void 0,this._showSubscription=void 0,this._definitionChanged=new n,this.merge(e??r.EMPTY_OBJECT)};Object.defineProperties(ne.prototype,{definitionChanged:{get:function(){return this._definitionChanged}},directions:e("directions"),lateralSurfaceMaterial:i("lateralSurfaceMaterial"),intersectionColor:e("intersectionColor"),intersectionWidth:e("intersectionWidth"),showIntersection:e("showIntersection"),radius:e("radius"),show:e("show")}),ne.prototype.clone=function(e){return t(e)||(e=new ne),e.directions=this.directions,e.radius=this.radius,e.show=this.show,e.showIntersection=this.showIntersection,e.intersectionColor=this.intersectionColor,e.intersectionWidth=this.intersectionWidth,e.lateralSurfaceMaterial=this.lateralSurfaceMaterial,e},ne.prototype.merge=function(e){if(!t(e))throw new o("source is required.");this.directions=this.directions??e.directions,this.radius=this.radius??e.radius,this.show=this.show??e.show,this.showIntersection=this.showIntersection??e.showIntersection,this.intersectionColor=this.intersectionColor??e.intersectionColor,this.intersectionWidth=this.intersectionWidth??e.intersectionWidth,this.lateralSurfaceMaterial=this.lateralSurfaceMaterial??e.lateralSurfaceMaterial};const re=S.WHITE,se=Number.POSITIVE_INFINITY,ae=new I,le=new s,he=new T,ce=function(e,i){if(!t(e))throw new o("scene is required.");if(!t(i))throw new o("entityCollection is required.");i.collectionChanged.addEventListener(ce.prototype._onCollectionChanged,this),this._scene=e,this._primitives=e.primitives,this._entityCollection=i,this._hash={},this._entitiesToVisualize=new b,this._onCollectionChanged(i,i.values,[],[])};ce.prototype.update=function(e){if(!t(e))throw new o("time is required.");for(var i=this._entitiesToVisualize.values,n=this._hash,r=this._primitives,a=0,l=i.length;a<l;a++){var h,c,u,m=i[a],f=m._customPatternSensor,_=n[m.id],p=m.isShowing&&m.isAvailable(e)&&E.getValueOrDefault(f._show,e,!0);if(p&&(h=E.getValueOrUndefined(m._position,e,le),c=E.getValueOrUndefined(m._orientation,e,he),u=E.getValueOrUndefined(f._directions,e),p=t(h)&&t(c)&&t(u)),p){var C=t(_)?_.primitive:void 0;t(C)||((C=new L).id=m,r.add(C),_={primitive:C,position:void 0,orientation:void 0},n[m.id]=_),s.equals(h,_.position)&&T.equals(c,_.orientation)||(d.fromRotationTranslation(I.fromQuaternion(c,ae),h,C.modelMatrix),_.position=s.clone(h,_.position),_.orientation=T.clone(c,_.orientation)),C.show=!0,C.directions=u,C.radius=E.getValueOrDefault(f._radius,e,se),C.lateralSurfaceMaterial=P.getValue(e,f._lateralSurfaceMaterial,C.lateralSurfaceMaterial),C.intersectionColor=E.getValueOrClonedDefault(f._intersectionColor,e,re,C.intersectionColor),C.intersectionWidth=E.getValueOrDefault(f._intersectionWidth,e,1)}else t(_)&&(_.primitive.show=!1)}return!0},ce.prototype.isDestroyed=function(){return!1},ce.prototype.destroy=function(){for(var e=this._entitiesToVisualize.values,i=this._hash,t=this._primitives,o=e.length-1;o>-1;o--)J(e[o],i,t);return C(this)},ce.prototype._onCollectionChanged=function(e,i,o,n){var r,s,a=this._entitiesToVisualize,l=this._hash,h=this._primitives;for(r=i.length-1;r>-1;r--)s=i[r],t(s._customPatternSensor)&&t(s._position)&&t(s._orientation)&&a.set(s.id,s);for(r=n.length-1;r>-1;r--)s=n[r],t(s._customPatternSensor)&&t(s._position)&&t(s._orientation)?a.set(s.id,s):(J(s,l,h),a.remove(s.id));for(r=o.length-1;r>-1;r--)J(s=o[r],l,h),a.remove(s.id)};const ue=function(){this._xHalfAngle=void 0,this._xHalfAngleSubscription=void 0,this._yHalfAngle=void 0,this._yHalfAngleSubscription=void 0,this._lateralSurfaceMaterial=void 0,this._lateralSurfaceMaterialSubscription=void 0,this._intersectionColor=void 0,this._intersectionColorSubscription=void 0,this._intersectionWidth=void 0,this._intersectionWidthSubscription=void 0,this._showIntersection=void 0,this._showIntersectionSubscription=void 0,this._radius=void 0,this._radiusSubscription=void 0,this._show=void 0,this._showSubscription=void 0,this._definitionChanged=new n};function de(e,i,o,n){var r=i[e];t(r)||(r=new H,i[e]=r),r.clock=o,r.cone=n,r.magnitude=1}function me(e){var i=e._customSensor.directions,t=Math.tan(Math.min(e._xHalfAngle,k.toRadians(89))),o=Math.tan(Math.min(e._yHalfAngle,k.toRadians(89))),n=Math.atan(t/o),r=Math.atan(Math.sqrt(t*t+o*o));de(0,i,n,r),de(1,i,k.toRadians(180)-n,r),de(2,i,k.toRadians(180)+n,r),de(3,i,-n,r),i.length=4,e._customSensor.directions=i}Object.defineProperties(ue.prototype,{definitionChanged:{get:function(){return this._definitionChanged}},xHalfAngle:e("xHalfAngle"),yHalfAngle:e("yHalfAngle"),lateralSurfaceMaterial:e("lateralSurfaceMaterial"),intersectionColor:e("intersectionColor"),intersectionWidth:e("intersectionWidth"),showIntersection:e("showIntersection"),radius:e("radius"),show:e("show")}),ue.prototype.clone=function(e){return t(e)||(e=new ue),e.xHalfAngle=this.xHalfAngle,e.yHalfAngle=this.yHalfAngle,e.radius=this.radius,e.show=this.show,e.showIntersection=this.showIntersection,e.intersectionColor=this.intersectionColor,e.intersectionWidth=this.intersectionWidth,e.lateralSurfaceMaterial=this.lateralSurfaceMaterial,e},ue.prototype.merge=function(e){if(!t(e))throw new o("source is required.");this.xHalfAngle=this.xHalfAngle??e.xHalfAngle,this.yHalfAngle=this.yHalfAngle??e.yHalfAngle,this.radius=this.radius??e.radius,this.show=this.show??e.show,this.showIntersection=this.showIntersection??e.showIntersection,this.intersectionColor=this.intersectionColor??e.intersectionColor,this.intersectionWidth=this.intersectionWidth??e.intersectionWidth,this.lateralSurfaceMaterial=this.lateralSurfaceMaterial??e.lateralSurfaceMaterial};const fe=function(e){e=e??r.EMPTY_OBJECT;var i=V(e);i._pickPrimitive=e._pickPrimitive??this,i.directions=void 0,this._customSensor=new L(i),this._xHalfAngle=e.xHalfAngle??k.PI_OVER_TWO,this._yHalfAngle=e.yHalfAngle??k.PI_OVER_TWO,me(this)};Object.defineProperties(fe.prototype,{xHalfAngle:{get:function(){return this._xHalfAngle},set:function(e){if(e>k.PI_OVER_TWO)throw new o("xHalfAngle must be less than or equal to 90 degrees.");this._xHalfAngle!==e&&(this._xHalfAngle=e,me(this))}},yHalfAngle:{get:function(){return this._yHalfAngle},set:function(e){if(e>k.PI_OVER_TWO)throw new o("yHalfAngle must be less than or equal to 90 degrees.");this._yHalfAngle!==e&&(this._yHalfAngle=e,me(this))}},show:{get:function(){return this._customSensor.show},set:function(e){this._customSensor.show=e}},showIntersection:{get:function(){return this._customSensor.showIntersection},set:function(e){this._customSensor.showIntersection=e}},showThroughEllipsoid:{get:function(){return this._customSensor.showThroughEllipsoid},set:function(e){this._customSensor.showThroughEllipsoid=e}},modelMatrix:{get:function(){return this._customSensor.modelMatrix},set:function(e){this._customSensor.modelMatrix=e}},radius:{get:function(){return this._customSensor.radius},set:function(e){this._customSensor.radius=e}},lateralSurfaceMaterial:{get:function(){return this._customSensor.lateralSurfaceMaterial},set:function(e){this._customSensor.lateralSurfaceMaterial=e}},intersectionColor:{get:function(){return this._customSensor.intersectionColor},set:function(e){this._customSensor.intersectionColor=e}},intersectionWidth:{get:function(){return this._customSensor.intersectionWidth},set:function(e){this._customSensor.intersectionWidth=e}},id:{get:function(){return this._customSensor.id},set:function(e){this._customSensor.id=e}}}),fe.prototype.update=function(e){this._customSensor.update(e)},fe.prototype.isDestroyed=function(){return!1},fe.prototype.destroy=function(){return this._customSensor=this._customSensor&&this._customSensor.destroy(),C(this)};const _e=S.WHITE,pe=Number.POSITIVE_INFINITY,Ce=new I,ge=new s,ve=new T,we=function(e,i){if(!t(e))throw new o("scene is required.");if(!t(i))throw new o("entityCollection is required.");i.collectionChanged.addEventListener(we.prototype._onCollectionChanged,this),this._scene=e,this._primitives=e.primitives,this._entityCollection=i,this._hash={},this._entitiesToVisualize=new b,this._onCollectionChanged(i,i.values,[],[])};we.prototype.update=function(e){if(!t(e))throw new o("time is required.");for(var i=this._entitiesToVisualize.values,n=this._hash,r=this._primitives,a=0,l=i.length;a<l;a++){var h,c,u=i[a],m=u._rectangularSensor,f=n[u.id],_=u.isShowing&&u.isAvailable(e)&&E.getValueOrDefault(m._show,e,!0);if(_&&(h=E.getValueOrUndefined(u._position,e,ge),c=E.getValueOrUndefined(u._orientation,e,ve),_=t(h)&&t(c)),_){var p=t(f)?f.primitive:void 0;t(p)||((p=new fe).id=u,r.add(p),f={primitive:p,position:void 0,orientation:void 0},n[u.id]=f),s.equals(h,f.position)&&T.equals(c,f.orientation)||(d.fromRotationTranslation(I.fromQuaternion(c,Ce),h,p.modelMatrix),f.position=s.clone(h,f.position),f.orientation=T.clone(c,f.orientation)),p.show=!0,p.xHalfAngle=E.getValueOrDefault(m._xHalfAngle,e,k.PI_OVER_TWO),p.yHalfAngle=E.getValueOrDefault(m._yHalfAngle,e,k.PI_OVER_TWO),p.radius=E.getValueOrDefault(m._radius,e,pe),p.lateralSurfaceMaterial=P.getValue(e,m._lateralSurfaceMaterial,p.lateralSurfaceMaterial),p.intersectionColor=E.getValueOrClonedDefault(m._intersectionColor,e,_e,p.intersectionColor),p.intersectionWidth=E.getValueOrDefault(m._intersectionWidth,e,1)}else t(f)&&(f.primitive.show=!1)}return!0},we.prototype.isDestroyed=function(){return!1},we.prototype.destroy=function(){for(var e=this._entitiesToVisualize.values,i=this._hash,t=this._primitives,o=e.length-1;o>-1;o--)J(e[o],i,t);return C(this)},we.prototype._onCollectionChanged=function(e,i,o,n){var r,s,a=this._entitiesToVisualize,l=this._hash,h=this._primitives;for(r=i.length-1;r>-1;r--)s=i[r],t(s._rectangularSensor)&&t(s._position)&&t(s._orientation)&&a.set(s.id,s);for(r=n.length-1;r>-1;r--)s=n[r],t(s._rectangularSensor)&&t(s._position)&&t(s._orientation)?a.set(s.id,s):(J(s,l,h),a.remove(s.id));for(r=o.length-1;r>-1;r--)J(s=o[r],l,h),a.remove(s.id)};var Se=W.processPacketData,ye=W.processMaterialPacketData;function Ae(e,i,o,n,r){var a,l,h=[],c=i.unitSpherical,u=i.spherical,d=i.unitCartesian,m=i.cartesian;if(t(c)){for(a=0,l=c.length;a<l;a+=2)h.push(new H(c[a],c[a+1]));i.array=h}else if(t(u)){for(a=0,l=u.length;a<l;a+=3)h.push(new H(u[a],u[a+1],u[a+2]));i.array=h}else if(t(d)){for(a=0,l=d.length;a<l;a+=3){var f=H.fromCartesian3(new s(d[a],d[a+1],d[a+2]));H.normalize(f,f),h.push(f)}i.array=h}else if(t(m)){for(a=0,l=m.length;a<l;a+=3)h.push(H.fromCartesian3(new s(m[a],m[a+1],m[a+2])));i.array=h}Se(Array,e,"directions",i,o,n,r)}function Me(e,i,t,o,n){Se(Boolean,e,"show",i.show,t,o,n),Se(Number,e,"radius",i.radius,t,o,n),Se(Boolean,e,"showIntersection",i.showIntersection,t,o,n),Se(S,e,"intersectionColor",i.intersectionColor,t,o,n),Se(Number,e,"intersectionWidth",i.intersectionWidth,t,o,n),ye(e,"lateralSurfaceMaterial",i.lateralSurfaceMaterial,t,o,n)}var xe={iso8601:void 0};function Ie(e,i,o,n){var r=i.agi_conicSensor;if(t(r)){var s,a=r.interval;t(a)&&(xe.iso8601=a,s=F.fromIso8601(xe));var l=e.conicSensor;t(l)||(e.addProperty("conicSensor"),l=new D,e.conicSensor=l),Me(l,r,s,n,o),Se(Number,l,"innerHalfAngle",r.innerHalfAngle,s,n,o),Se(Number,l,"outerHalfAngle",r.outerHalfAngle,s,n,o),Se(Number,l,"minimumClockAngle",r.minimumClockAngle,s,n,o),Se(Number,l,"maximumClockAngle",r.maximumClockAngle,s,n,o)}}function Te(e,i,o,n){var r=i.agi_customPatternSensor;if(t(r)){var s,a=r.interval;t(a)&&(xe.iso8601=a,s=F.fromIso8601(xe));var l=e.customPatternSensor;t(l)||(e.addProperty("customPatternSensor"),l=new ne,e.customPatternSensor=l),Me(l,r,s,n,o);var h=r.directions;if(t(h))if(Array.isArray(h))for(var c=h.length,u=0;u<c;u++)Ae(l,h[u],s,n,o);else Ae(l,h,s,n,o)}}function be(e,i,o,n){var r=i.agi_rectangularSensor;if(t(r)){var s,a=r.interval;t(a)&&(xe.iso8601=a,s=F.fromIso8601(xe));var l=e.rectangularSensor;t(l)||(e.addProperty("rectangularSensor"),l=new ue,e.rectangularSensor=l),Me(l,r,s,n,o),Se(Number,l,"xHalfAngle",r.xHalfAngle,s,n,o),Se(Number,l,"yHalfAngle",r.yHalfAngle,s,n,o)}}var Ee=!1;return function(){if(!Ee){W.updaters.push(Ie,Te,be);var e=O.defaultVisualizersCallback;O.defaultVisualizersCallback=function(i,t,o){var n=o.entities;return e(i,t,o).concat([new oe(i,n),new ce(i,n),new we(i,n)])},Ee=!0}}(),{ConicSensorGraphics:D,ConicSensorVisualizer:oe,CustomPatternSensorGraphics:ne,CustomPatternSensorVisualizer:ce,CustomSensorVolume:L,RectangularPyramidSensorVolume:fe,RectangularSensorGraphics:ue,RectangularSensorVisualizer:we}});
